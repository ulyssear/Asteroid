(()=>{Array.prototype.chunk=function(e){var t=this;return[].concat.apply([],t.map(function(o,i){return i%e?[]:[t.slice(i,i+e)]}))};Array.prototype.chunkWithExtremums=function(e,t){return this.length%e<=t?this.chunkWithExtremums(t,e-1):this.chunk(e)};var _=!1,x=!0,v=13,I=!1,A=!1,n=document.querySelector("canvas"),r=n.getContext("2d"),S=new Audio("sounds/ship_fire.wav"),U=new Audio("sounds/ship_explosion.wav"),z=new Audio("sounds/explosion.wav");n.width=n.offsetWidth;n.height=n.offsetHeight;var w=class{static DEFAULT(){return{name:"Un nom",position:[n.width/2,n.height/2],points:[],clones:{left:!1,right:!1,top:!1,bottom:!1},velocity:null,rotationVelocity:null,rotation:null,size:30,color:"white",friction:.965,isClone:!1,mayCollapse:!1}}constructor(t={}){t=Object.assign(P.DEFAULT(),t);for(let o in t)this[o]=t[o];this.id=this.id??Math.random().toString(16).slice(3)}setColor(t){this.color=t}},P=class extends w{static DEFAULT(){return{name:"Joueur",speed:0,bullets:[],canFire:!0,canRotate:!0,velocity:[0,0]}}constructor(t={}){super(t),t={...w.DEFAULT(),...P.DEFAULT(),...t};for(let o in t)this[o]=t[o];this.points=[[-this.size/3,this.size/3],[0,-this.size/2],[this.size/3,this.size/3]],this.rotation=-90,this.draw()}draw(){W(this);try{this.bullets.forEach(t=>{if(t.move(),B(t.position)){this.bullets.splice(this.bullets.indexOf(t),1);return}t.draw()})}catch(t){console.error(t)}}rotateLeft(){if(!this.canRotate)return;let t=4;this.rotationVelocity=-t*Math.PI/180,this.rotation=(this.rotation-t)%360,C(this)}rotateRight(){if(!this.canRotate)return;let t=4;this.rotationVelocity=t*Math.PI/180,this.rotation=(this.rotation+t)%360,C(this)}accelerate(){this.speed+=.45,this.velocity=[this.speed*Math.cos(this.rotation*Math.PI/180),this.speed*Math.sin(this.rotation*Math.PI/180)];let t=5*10;this.velocity=[Math.round(this.velocity[0]*t)/t,Math.round(this.velocity[1]*t)/t],this.speed=Math.round(this.speed*t)/t}move(){let[t,o]=this.velocity.map(i=>i*this.friction);this.position=T([this.position],this.velocity)[0],this.speed*=this.friction,this.velocity=[Math.round(t*1e3)/1e3,Math.round(o*1e3)/1e3],this.speed=Math.round(this.speed*1e3)/1e3,this.speed<.02&&(this.speed=0,this.velocity=[0,0])}fire(){if(!this.canFire)return;this.canFire=!1;let t,{position:o,rotation:i}=this;t=new k({position:o,rotation:i}),this.bullets.push(t),K()}explode(){this.isDead||tt(),this.isDead=!0,this.canFire=!1,this.canRotate=!1,A=!0}},k=class extends w{static DEFAULT(){return{friction:1,speed:5,points:[[0,0]]}}constructor(t={}){super(t),t={...w.DEFAULT(),...k.DEFAULT(),...t};for(let o in t)this[o]=t[o];this.velocity=[Math.cos(this.rotation*Math.PI/180)*this.speed,Math.sin(this.rotation*Math.PI/180)*this.speed],this.draw()}move(){this.position=T([this.position],this.velocity)[0],this.velocity=this.velocity.map(t=>t*this.friction),this.speed=Math.sqrt(this.velocity[0]**2+this.velocity[1]**2)}draw(){let[t,o]=this.position;r.fillStyle="#ffffff",r.beginPath(),r.arc(t,o,2,0,Math.PI*2),r.fill()}},y=class extends w{static DEFAULT(){return{friction:1,size:null,position:null,rotation:null,velocity:null}}constructor(t={}){super(t),t={...w.DEFAULT(),...y.DEFAULT(),...t};for(let o in t)this[o]=t[o];this.size=this.size??Math.floor(Math.random()*8+5),this.angle=this.angle??Math.random()*360,this.position=this.position??[Math.round(Math.random()*(n.width-400)+200),Math.round(Math.random()*(n.height-400)+200)],this.rotation=this.rotation??Math.floor(Math.random()*360),this.velocity=this.velocity??[Math.cos(this.rotation*Math.PI/180)*1,Math.sin(this.rotation*Math.PI/180)*1],this.rotationVelocity=this.rotationVelocity??6e-4,this.points=1>this.points.length||!this.points?this.createPoints():this.points,this.clones=this.clones??{left:!1,right:!1,top:!1,bottom:!1}}createPoints(){let t=[],{angle:o,size:i}=this,s=360/this.size;for(let h=0;h<this.size;h++){let l=o+s*h,c=Math.cos(l*Math.PI/180)*i*6.5-Math.cos(l*Math.PI/180)*Math.random()*this.size*3.45,a=Math.sin(l*Math.PI/180)*i*6.5-Math.sin(l*Math.PI/180)*Math.random()*this.size*3.45;t.push([c,a])}return t}move(){this.position=T([this.position],this.velocity)[0],this.rotate()}explode(){if(this.size>12){let{position:t}=this,o=j([...this.points]).chunkWithExtremums(12,7);o=o.map(s=>[[0,0],...s]).map(s=>s.map(h=>[h[0]+t[0],h[1]+t[1]]));let i=o.map(s=>J(s));o=o.map((s,h)=>s.map(l=>[l[0]-i[h][0],l[1]-i[h][1]])),o=o.map(s=>j(s));for(let s=0;s<o.length;s++){let h=new y({size:Math.ceil(this.size/o.length),points:o[s],position:i[s],rotation:this.rotation,rotationVelocity:this.rotationVelocity,velocity:D(this.velocity,360/o.length*s)});b.push(h)}}N(),b.splice(b.indexOf(this),1)}draw(){try{W(this)}catch(t){console.log(t)}}rotate(){this.points=this.points.map(t=>D(t,this.rotationVelocity))}static generate(t=1,o=[]){if(t>0){let i=new y;return!1?y.generate(t,o):(o.push(i),y.generate(t-1,o))}return o}static generateAt(t,o){let i=[];for(let s=0;s<t;s++){let h=new y({position:o});i.push(h)}return i}};function Y(e){let t=e.clones??{left:!1,right:!1,top:!1,bottom:!1,d_top_left:!1,d_top_right:!1,d_bottom_left:!1,d_bottom_right:!1},[o,i]=e.position;for(let s=0;s<e.points.length;s++){let[h,l]=e.points[s],c={left:h+o<=0,right:h+o>=n.width,top:l+i<=0,bottom:l+i>=n.height};if(Object.values(c).reduce((a,u)=>a||u))for(let a in c)c[a]&&(t[a]=c[a])}t.left&&t.top&&(t.d_top_left=!0),t.right&&t.top&&(t.d_top_right=!0),t.left&&t.bottom&&(t.d_bottom_left=!0),t.right&&t.bottom&&(t.d_bottom_right=!0),e.clones=t}function H([e,t],[o,i],[s,h],l){r.beginPath(),r.moveTo(o+e,i+t),r.lineTo(s+e,h+t),r.strokeStyle=l,r.stroke()}function Q(e,[t,o],i){r.beginPath(),r.arc(t,o,e/2,0,2*Math.PI),r.fillStyle=i,r.fill()}function T(e,[t,o]){return e.map(([i,s])=>[i+t,s+o])}function X(e){let{clones:t,position:o,points:i}=e,[s,h]=o;if(Object.values(t).includes(!0)){let l=Object.keys(t).find(p=>t[p]),[c,a]={left:[n.width,0],right:[-n.width,0],top:[0,n.height],bottom:[0,-n.height],d_top_left:[n.width,n.height],d_top_right:[-n.width,n.height],d_bottom_left:[n.width,-n.height],d_bottom_right:[-n.width,-n.height]}[l];i.map(([p,d])=>[p+s,d+h]).map(B).reduce((p,d)=>p&&d)&&(e.position=T([o],[c,a])[0],e.clones[l]=!1)}}function q(e){let t={},o={left:[n.width,0],right:[-n.width,0],top:[0,n.height],bottom:[0,-n.height],d_top_left:[n.width,n.height],d_top_right:[-n.width,n.height],d_bottom_left:[n.width,-n.height],d_bottom_right:[-n.width,-n.height]};for(let i in o)e.clones[i]&&(t[i]=T([e.position],o[i])[0]);return t}function C(e){e.points=Z(e.points,e.rotationVelocity)}function Z(e,t=0){return e.map(o=>D(o,t))}function D([e,t],o=0){return[e*Math.cos(o)-t*Math.sin(o),e*Math.sin(o)+t*Math.cos(o)].map(i=>Math.floor(i*1e3)/1e3)}function W(e){try{e.move(),Y(e),X(e),R(e);let t=q(e);for(let o in t){let i=t[o];R({...e,position:i})}}catch(t){console.error(t)}}function R(e){let{rotation:t,position:o,speed:i}=e,[s,h]=o;o.length!==2&&console.debug({another_position:o}),r.beginPath(),x&&(r.moveTo(...o),r.lineTo(s+Math.cos(t*Math.PI/180)*(2*i),h+Math.sin(t*Math.PI/180)*(2*i)),r.strokeStyle="red",r.lineWidth=2,r.stroke()),r.lineJoin="round",r.lineCap="round";for(let l=0;l<e.points.length;l++){let[c,a]=e.points[l],[u,p]=e.points[(l+1)%e.points.length];H(o,[c,a],[u,p],e.color),x&&Q(3,[c+s,a+h],"red")}}function B([e,t]){return e<0||e>n.width||t<0||t>n.height}function V(e,t){let[o,i]=e.position,[s,h]=t.position;e.mayCollapse=!0,t.mayCollapse=!0;let l=e.points.map(([a,u])=>[a+o,u+i]),c=t.points.map(([a,u])=>[a+s,u+h]);l.length===1&&l.push([l[0][0]+e.velocity[0],l[0][1]+e.velocity[1]]),c.length===1&&c.push([c[0][0]+t.velocity[0],c[0][1]+t.velocity[1]]);for(let a=0;a<l.length;a++){let u=l[a].map((d,m)=>d+e.velocity[m]),p=l[(a+1)%l.length].map((d,m)=>d+e.velocity[m]);for(let d=0;d<c.length;d++){let m=c[d].map((M,O)=>M+t.velocity[O]),E=c[(d+1)%c.length].map((M,O)=>M+t.velocity[O]);if(G(u,p,m,E))return!0}return e.mayCollapse=!1,t.mayCollapse=!1,!1}return!1}function G(e,t,o,i){let[s,h]=e,[l,c]=t,[a,u]=o,[p,d]=i,m=(d-u)*(l-s)-(p-a)*(c-h);if(m==0)return!1;let E=((p-a)*(h-u)-(d-u)*(s-a))/m,M=((l-s)*(h-u)-(c-h)*(s-a))/m;return E>=0&&E<=1&&M>=0&&M<=1}function J(e){let t=0,o=0;for(let[i,s]of e)t+=i,o+=s;return[t/e.length,o/e.length]}function j(e){let t=J(e);return e.sort((o,i)=>{let[s,h]=o,[l,c]=i,a=Math.atan2(h-t[1],s-t[0]),u=Math.atan2(c-t[1],l-t[0]);return a-u})}function K(){S.currentTime=0,S.play()}function N(){z.currentTime=0,z.volume=.5,z.play()}function tt(){U.currentTime=0,U.play()}var f=new P,b=y.generate(0),g={"rotate left":{keys:["ArrowLeft","q","Q"],action:f.rotateLeft},"rotate right":{keys:["ArrowRight","d","D"],action:f.rotateRight},accelerate:{keys:["ArrowUp","z","Z"],action:f.accelerate},fire:{keys:["Enter"," "],action:f.fire},pause:{keys:["p"],action:()=>{_=!_},canOnPause:!0},debug:{keys:["m","M"],action:()=>{x=!x},canOnPause:!0},tab:{keys:["Tab"],action:()=>{I=!I}}};for(let e in g)g[e].canOnPause=g[e].canOnPause??!1,g[e].lastTimeUsed=null;var F={};window.addEventListener("keyup",e=>{delete F[e.key],!A&&g.fire.keys.every(t=>!Object.keys(F).includes(t))&&(f.canFire=!0)});window.addEventListener("keydown",e=>{F[e.key]=!0});window.addEventListener("wheel",e=>{x&&(e.deltaY>0?v=Math.max(v-1,8):v=Math.min(v+1,32))});n.addEventListener("click",e=>{let t=n.getBoundingClientRect(),o=e.clientX-t.left,i=e.clientY-t.top;b.push(new y({position:[o,i],size:v}))});var $=Date.now(),L=()=>{try{for(let e in F)for(let t in g)g[t].keys.includes(e)&&(!_||_&&g[t].canOnPause)&&(["pause","debug"].includes(t)?Date.now()-g[t].lastTimeUsed>100&&(g[t].action.bind(f)(),g[t].lastTimeUsed=Date.now()):g[t].action.bind(f)())}catch(e){console.error(e)}if(_){requestAnimationFrame(L);return}r.clearRect(0,0,n.width,n.height),b.forEach(e=>{let t=[e];t.push(...Object.values(q(e)).map(o=>({...e,position:o}))),t.forEach(o=>{V(f,o)&&f.explode(),f.bullets.forEach(i=>{V(i,o)&&(e.explode(),f.bullets.splice(f.bullets.indexOf(i),1))})}),e.draw()}),A&&f.velocity!==[0,0]&&(f.speed=0,f.velocity=[0,0],f.rotationVelocity=0),f.isDead||f.draw(),x&&(r.font="24px VT323",r.fillStyle="white",r.fillText(`FPS: ${Math.round(1e3/(Date.now()-$))}`,10,20),r.fillStyle="white",r.font="13px VT323",r.fillText(`${f.position}`,10,40),r.fillText(`${f.speed}`,10,55),f.bullets[0]&&r.fillText(`${f.bullets[0].position}`,10,70),r.fillText(`Asteroids : ${b.length}`,10,85),r.fillText(`Selected Size : ${v}`,10,100)),$=Date.now(),requestAnimationFrame(L)};L();})();
